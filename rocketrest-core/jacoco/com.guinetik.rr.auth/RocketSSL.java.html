<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RocketSSL.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script>
<!-- <!-- terminal-javadocs-injected [coverage] -->
<link rel="stylesheet" href="../../../terminal-styles/terminaljavadocs-coverage.min.css">
<script src="../../../terminal-styles/terminaljavadocs.min.js" defer></script>
</head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">RocketRest Core</a> &gt; <a href="index.source.html" class="el_package">com.guinetik.rr.auth</a> &gt; <span class="el_source">RocketSSL.java</span></div><h1>RocketSSL.java</h1><pre class="source lang-java linenums">package com.guinetik.rr.auth;

import com.guinetik.rr.RocketRestConfig;
import com.guinetik.rr.http.RocketClient;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import javax.net.ssl.KeyManagerFactory;
import javax.net.ssl.SSLContext;
import javax.net.ssl.TrustManager;
import javax.net.ssl.X509TrustManager;
import java.io.InputStream;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.security.KeyStore;
import java.security.NoSuchAlgorithmException;
import java.security.cert.X509Certificate;
import java.util.HashMap;
import java.util.Map;

/**
 * Utility class for handling SSL (TLS 1.2 and 1.3) certificates and contexts.
 * Used for setting up secure connections with custom certificates.
 */
<span class="fc" id="L25">public class RocketSSL {</span>

<span class="fc" id="L27">    private static final Logger logger = LoggerFactory.getLogger(RocketSSL.class);</span>

    /**
     * Interface for objects that can provide certificate information.
     */
    public interface SSLConfig {
        String getCustomCertificateFilename();

        String getCustomCertificatePassword();

        boolean isCustomCertificateEnabled();
    }

    /**
     * Interface for authentication strategies that can be configured with an SSL context.
     * This interface is implemented by strategies that need to make HTTPS requests,
     * such as OAuth2 strategies that need to get tokens from a server.
     */
    public interface SSLAware {

        /**
         * Sets the SSL context to be used for HTTPS requests made by the strategy.
         *
         * @param sslContext the SSL context to use
         */
        void configureSsl(SSLContext sslContext);
    }

    /**
     * Class representing certificate information.
     */
    public static class SSLCertificate {
        private String certificateFilename;
        private String certificatePassword;

<span class="fc" id="L62">        public SSLCertificate(String certificateFilename, String certificatePassword) {</span>
<span class="fc" id="L63">            this.certificateFilename = certificateFilename;</span>
<span class="fc" id="L64">            this.certificatePassword = certificatePassword;</span>
<span class="fc" id="L65">        }</span>

<span class="fc" id="L67">        public SSLCertificate() {</span>
<span class="fc" id="L68">        }</span>

        public String getCertificateFilename() {
<span class="fc" id="L71">            return certificateFilename;</span>
        }

        public void setCertificateFilename(String certificateFilename) {
<span class="fc" id="L75">            this.certificateFilename = certificateFilename;</span>
<span class="fc" id="L76">        }</span>

        public String getCertificatePassword() {
<span class="fc" id="L79">            return certificatePassword;</span>
        }

        public void setCertificatePassword(String certificatePassword) {
<span class="fc" id="L83">            this.certificatePassword = certificatePassword;</span>
<span class="fc" id="L84">        }</span>
    }

<span class="fc" id="L87">    private Map&lt;String, SSLContext&gt; sslContexts = new HashMap&lt;&gt;();</span>

    /**
     * Gets the SSL context for the given certificate information.
     *
     * @param SSLCertificate the certificate information
     * @return the SSL context, or null if an error occurred
     */
    public synchronized SSLContext getSSLContext(SSLCertificate SSLCertificate) {
<span class="fc" id="L96">        return getSSLContext(SSLCertificate.getCertificateFilename(), SSLCertificate.getCertificatePassword());</span>
    }

    /**
     * Gets the SSL context for the given certificate file and password.
     *
     * @param fileName the certificate file path
     * @param certPass the certificate password
     * @return the SSL context, or null if an error occurred
     */
    public synchronized SSLContext getSSLContext(String fileName, String certPass) {
        SSLContext sc;
<span class="pc bpc" id="L108" title="1 of 2 branches missed.">        if (sslContexts.get(fileName) != null)</span>
<span class="nc" id="L109">            return sslContexts.get(fileName);</span>
        try {
<span class="fc" id="L111">            TrustManager tm = new X509TrustManager() {</span>
                public void checkClientTrusted(X509Certificate[] chain, String authType) {
<span class="nc" id="L113">                }</span>

                public void checkServerTrusted(X509Certificate[] chain, String authType) {
<span class="nc" id="L116">                }</span>

                public X509Certificate[] getAcceptedIssuers() {
<span class="nc" id="L119">                    return null;</span>
                }
            };

<span class="pc bpc" id="L123" title="1 of 4 branches missed.">            if (fileName == null || certPass == null) {</span>
<span class="fc" id="L124">                throw new IllegalArgumentException(&quot;Security certificate file name or password not found.&quot;);</span>
            }
            KeyManagerFactory kmf;

<span class="nc" id="L128">            kmf = KeyManagerFactory.getInstance(&quot;SunX509&quot;);</span>

<span class="nc" id="L130">            InputStream fis = null;</span>
            try {
<span class="nc" id="L132">                KeyStore ks = KeyStore.getInstance(&quot;PKCS12&quot;);</span>
<span class="nc" id="L133">                fis = Files.newInputStream(Paths.get(fileName));</span>
<span class="nc" id="L134">                ks.load(fis, certPass.toCharArray());</span>
<span class="nc" id="L135">                kmf.init(ks, certPass.toCharArray());</span>
            } finally {
<span class="nc bnc" id="L137" title="All 2 branches missed.">                if (fis != null) {</span>
<span class="nc" id="L138">                    fis.close();</span>
                }
            }
            try {
                // Try TLS 1.3 first
<span class="nc" id="L143">                sc = SSLContext.getInstance(&quot;TLSv1.3&quot;);</span>
<span class="nc" id="L144">            } catch (NoSuchAlgorithmException e) {</span>
                // Fall back to TLS 1.2 if 1.3 is not available
<span class="nc" id="L146">                logger.info(&quot;TLS 1.3 not available, falling back to TLS 1.2&quot;);</span>
<span class="nc" id="L147">                sc = SSLContext.getInstance(&quot;TLSv1.2&quot;);</span>
<span class="nc" id="L148">            }</span>
<span class="nc" id="L149">            sc.init(kmf.getKeyManagers(), new TrustManager[]{tm}, null);</span>
<span class="nc" id="L150">            sslContexts.put(fileName, sc);</span>
<span class="fc" id="L151">        } catch (Exception e) {</span>
<span class="fc" id="L152">            logger.error(&quot;Exception occurred getting SSL context: {}&quot;, e.getMessage());</span>
<span class="fc" id="L153">            return null;</span>
<span class="nc" id="L154">        }</span>

<span class="nc" id="L156">        return sc;</span>
    }

    /**
     * Configures SSL for a client if the provided config implements SSLAware and has a custom
     * certificate enabled.
     *
     * @param client The client to configure
     * @param config The configuration that might contain SSL settings
     * @return true if SSL was successfully configured, false otherwise
     */
    public static boolean configureSsl(RocketClient client, RocketRestConfig config) {
<span class="fc bfc" id="L168" title="All 2 branches covered.">        if (!(config instanceof SSLConfig)) {</span>
<span class="fc" id="L169">            return false;</span>
        }

<span class="fc" id="L172">        SSLConfig certConfig = (SSLConfig) config;</span>

<span class="fc bfc" id="L174" title="All 2 branches covered.">        if (!certConfig.isCustomCertificateEnabled()) {</span>
<span class="fc" id="L175">            return false;</span>
        }

<span class="fc" id="L178">        String certFile = certConfig.getCustomCertificateFilename();</span>
<span class="fc" id="L179">        String certPass = certConfig.getCustomCertificatePassword();</span>

<span class="pc bpc" id="L181" title="1 of 4 branches missed.">        if (certFile == null || certPass == null) {</span>
<span class="fc" id="L182">            logger.warn(&quot;Certificate file or password is null&quot;);</span>
<span class="fc" id="L183">            return false;</span>
        }

<span class="nc" id="L186">        logger.info(&quot;Configuring SSL with custom certificate: {}&quot;, certFile);</span>

<span class="nc" id="L188">        SSLCertificate cert = new SSLCertificate(certFile, certPass);</span>
<span class="nc" id="L189">        RocketSSL ssl = new RocketSSL();</span>
<span class="nc" id="L190">        SSLContext sslContext = ssl.getSSLContext(cert);</span>

<span class="nc bnc" id="L192" title="All 2 branches missed.">        if (sslContext == null) {</span>
<span class="nc" id="L193">            logger.error(&quot;Failed to configure SSL context with certificate: {}&quot;, certFile);</span>
<span class="nc" id="L194">            return false;</span>
        }

        // Configure HTTP client
<span class="nc" id="L198">        client.configureSsl(sslContext);</span>

        // Configure auth strategy if it supports SSL
<span class="nc bnc" id="L201" title="All 2 branches missed.">        if (config.getAuthStrategy() instanceof SSLAware) {</span>
<span class="nc" id="L202">            ((SSLAware) config.getAuthStrategy()).configureSsl(sslContext);</span>
<span class="nc" id="L203">            logger.info(&quot;SSL context configured for authentication strategy&quot;);</span>
        }

<span class="nc" id="L206">        logger.info(&quot;SSL context configured successfully&quot;);</span>
<span class="nc" id="L207">        return true;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>